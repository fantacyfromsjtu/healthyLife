# 健康生活应用设计文档

## 1. 项目概述

### 1.1 设计目标

"健康生活"应用旨在创建一个全面的个人健康管理平台，帮助用户记录、分析和优化其日常饮食、运动和睡眠习惯。本设计文档详细说明了应用的技术实现方案，确保系统的可用性、可靠性和可扩展性。主要设计目标如下：

- **全面的健康数据管理**：构建一个集中式平台，用于管理用户的饮食、运动和睡眠数据。
- **直观的数据可视化**：提供清晰、易懂的图表和统计信息，帮助用户理解其健康状况。
- **个性化健康建议**：基于用户的健康数据和目标，提供个性化的建议和计划。
- **用户友好的界面**：设计简洁、直观的界面，降低用户使用门槛。
- **数据安全与隐私保护**：确保用户健康数据的安全存储和传输，保护用户隐私。

### 1.2 设计原则

为确保"健康生活"应用达到预期的质量标准，我们遵循以下设计原则：

- **用户中心设计**：所有功能和界面设计都以用户需求和体验为中心，确保应用易于使用且功能实用。
- **模块化设计**：将系统划分为多个相对独立的模块，便于开发、测试和维护，同时提高代码复用性。
- **数据驱动决策**：应用基于用户的实际健康数据提供分析和建议，而非采用一刀切的通用方案。
- **渐进式增强**：系统支持基本功能的同时，允许随着用户需求的增加和技术的进步进行功能扩展。
- **响应式设计**：界面能够适应不同屏幕尺寸和分辨率，提供一致的用户体验。
- **安全优先**：在设计的每个环节都考虑数据安全和隐私保护，采用最佳安全实践。
- **离线可用性**：关键功能支持在没有网络连接的情况下工作，数据在重新连接后同步。

### 1.3 技术栈选择

基于项目需求和设计原则，我们选择了以下技术栈：

- **前端技术**：
  - **PyQt5框架**：选择PyQt5作为GUI开发框架，提供跨平台的桌面应用程序支持。
  - **Matplotlib**：用于数据可视化，生成各类健康数据图表。
  - **Qt Style Sheets (QSS)**：用于自定义界面样式，提升用户视觉体验。

- **后端技术**：
  - **Python**：作为主要开发语言，具有丰富的库支持和较高的开发效率。
  - **SQLite**：轻量级关系型数据库，用于本地数据存储，无需额外的数据库服务器。
  - **QtSQL**：PyQt5的数据库接口，用于应用程序与SQLite数据库之间的通信。

- **数据处理与分析**：
  - **NumPy & Pandas**：用于健康数据的处理和分析。
  - **SciPy**：提供科学计算能力，用于复杂的健康指标计算。

- **安全性技术**：
  - **Hashlib**：用于密码哈希处理，增强用户认证安全性。
  - **Python-dotenv**：管理环境变量和敏感配置，避免硬编码敏感信息。

- **开发工具与环境**：
  - **Git**：版本控制系统，协调开发过程。
  - **Visual Studio Code / PyCharm**：推荐的代码编辑器。
  - **Pytest**：用于编写和运行自动化测试。

通过这些技术的组合，我们将构建一个功能完善、用户友好、安全可靠的健康管理应用。

## 2. 系统架构设计

### 2.1 总体架构

"健康生活"应用采用分层架构设计，将系统划分为表示层、业务逻辑层和数据访问层，以实现关注点分离和职责明确。此架构有利于系统的可维护性、可测试性和可扩展性。

![系统总体架构图]

#### 表示层（UI层）
处理用户界面和用户交互，负责显示数据和收集用户输入。主要包括：
- 登录和注册界面
- 主应用窗口
- 各功能模块的界面组件（饮食、运动、睡眠记录和分析）
- 报表与图表显示组件
- 设置和配置界面

#### 业务逻辑层
实现应用的核心功能和业务规则，处理来自表示层的请求，并与数据访问层交互获取和持久化数据。主要包括：
- 用户管理服务
- 饮食管理服务
- 运动管理服务
- 睡眠管理服务
- 健康分析服务
- 报告生成服务
- 提醒服务

#### 数据访问层
负责与数据存储系统（SQLite数据库）交互，提供数据的增删改查操作。主要包括：
- 数据库连接管理
- 数据模型对象
- 数据访问接口
- 数据查询和持久化操作

#### 跨层次组件
提供整个应用所需的共享服务和功能：
- 配置管理
- 日志服务
- 异常处理
- 安全服务（认证、授权）
- 通用工具类和辅助函数

### 2.2 模块划分

基于系统的功能需求和总体架构，我们将应用划分为以下主要模块：

#### 核心模块
- **应用核心(app.py)**：应用程序的入口点，负责初始化和协调其他模块。
- **配置管理**：加载和管理应用配置，支持不同环境的配置切换。

#### 用户界面模块
- **登录界面(login.py)**：用户认证入口，提供登录和注册功能。
- **主窗口(main_window.py)**：应用的主界面，整合所有功能模块。
- **饮食管理界面(diet_*.py)**：录入和查看饮食数据的界面组件。
- **运动管理界面(exercise_*.py)**：录入和查看运动数据的界面组件。
- **睡眠管理界面(sleep_*.py)**：录入和查看睡眠数据的界面组件。
- **健康报告界面**：显示健康分析报告和建议的界面。
- **提醒管理界面(reminder.py)**：设置和管理提醒的界面。
- **自定义组件(custom_widgets.py)**：通用的UI组件，提高代码复用率。

#### 业务逻辑模块
- **用户管理**：处理用户认证和授权，管理用户配置文件。
- **饮食管理**：处理饮食记录的添加、修改、删除和查询。
- **运动管理**：处理运动记录的添加、修改、删除和查询。
- **睡眠管理**：处理睡眠记录的添加、修改、删除和查询。
- **健康分析(health_analyzer.py)**：分析健康数据，生成健康趋势和建议。
- **报告生成(report_generator.py)**：创建可视化报告，支持导出功能。
- **提醒服务**：管理提醒任务，触发通知。

#### 数据访问模块
- **数据库管理器(db_manager.py)**：提供数据库连接和操作接口。
- **数据模型**：定义数据结构和关系，映射到数据库表。
- **数据访问对象**：提供特定领域对象的CRUD操作。

#### 工具和辅助模块
- **验证工具(verification.py)**：提供输入验证和数据校验功能。
- **样式助手(style_helper.py)**：管理应用的视觉样式，提供样式切换功能。
- **日志服务**：记录应用行为和错误信息，便于调试和问题追踪。
- **导入/导出工具**：支持健康数据的导入和导出功能。

### 2.3 模块间交互

模块之间通过明确的接口和数据流进行交互，以确保松耦合和高内聚。主要交互流程如下：

#### 用户身份验证流程
1. 用户通过登录界面输入凭证
2. 登录界面将凭证传递给用户管理服务
3. 用户管理服务通过数据访问层验证凭证
4. 验证结果返回给登录界面
5. 成功登录后，主窗口被初始化，用户信息被加载

#### 健康数据记录流程
1. 用户通过相应界面输入健康数据（饮食、运动、睡眠）
2. 界面组件调用业务逻辑服务进行数据验证和处理
3. 业务逻辑服务通过数据访问层将数据保存到数据库
4. 操作结果反馈给用户界面

#### 健康分析和报告生成流程
1. 用户通过主窗口请求健康分析或报告
2. 请求传递给健康分析服务或报告生成服务
3. 服务通过数据访问层检索所需健康数据
4. 服务处理和分析数据，生成结果或报告
5. 结果返回给界面显示给用户

#### 提醒通知流程
1. 提醒服务监控计划的提醒时间
2. 当到达提醒时间，提醒服务触发通知
3. 通知通过界面组件显示给用户
4. 用户与通知交互后，结果返回给提醒服务更新提醒状态

通过这种明确的模块化设计和交互流程，"健康生活"应用能够实现功能间的有效分离和协作，便于团队开发和系统维护。

## 3. 数据库设计

### 3.1 ER图

"健康生活"应用的数据库ER图展示了系统中的实体及其关系。主要实体包括用户、食物、运动、饮食记录、运动记录、睡眠记录、提醒事项等。通过使用ER图，我们可以直观地理解数据结构和实体间的关系。

![数据库ER图]

### 3.2 数据库表结构

#### 3.2.1 用户表 (users)

存储用户基本信息和认证数据。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| user_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 用户唯一标识 |
| username | TEXT | NOT NULL, UNIQUE | 用户名 |
| password_hash | TEXT | NOT NULL | 密码哈希 |
| salt | TEXT | NOT NULL | 密码盐值 |
| email | TEXT | UNIQUE | 电子邮件 |
| full_name | TEXT | | 用户全名 |
| gender | TEXT | | 性别 |
| birth_date | DATE | | 出生日期 |
| height | REAL | | 身高(cm) |
| weight | REAL | | 体重(kg) |
| activity_level | TEXT | | 活动水平 |
| goal | TEXT | | 健康目标 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| last_login | DATETIME | | 最后登录时间 |
| theme_preference | TEXT | | 主题偏好 |
| notification_preference | TEXT | | 通知偏好 |

#### 3.2.2 饮食记录表 (diet_records)

记录用户的饮食情况，包括食物、分量、热量等信息。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| record_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 记录唯一标识 |
| user_id | INTEGER | NOT NULL, FOREIGN KEY | 关联用户ID |
| date | DATE | NOT NULL | 记录日期 |
| meal_type | TEXT | NOT NULL | 餐类型(早餐/午餐/晚餐/加餐) |
| food_id | INTEGER | FOREIGN KEY | 关联食物ID |
| food_name | TEXT | NOT NULL | 食物名称 |
| quantity | REAL | NOT NULL | 食物分量 |
| unit | TEXT | NOT NULL | 计量单位 |
| calories | REAL | NOT NULL | 摄入热量(kcal) |
| protein | REAL | | 蛋白质含量(g) |
| fat | REAL | | 脂肪含量(g) |
| carbohydrates | REAL | | 碳水化合物含量(g) |
| fiber | REAL | | 纤维含量(g) |
| water | REAL | | 水分含量(ml) |
| notes | TEXT | | 备注 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

#### 3.2.3 运动记录表 (exercise_records)

记录用户的运动情况，包括运动类型、时长、消耗热量等信息。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| record_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 记录唯一标识 |
| user_id | INTEGER | NOT NULL, FOREIGN KEY | 关联用户ID |
| date | DATE | NOT NULL | 记录日期 |
| exercise_id | INTEGER | FOREIGN KEY | 关联运动类型ID |
| exercise_name | TEXT | NOT NULL | 运动名称 |
| duration | INTEGER | NOT NULL | 运动时长(分钟) |
| intensity | TEXT | | 运动强度(低/中/高) |
| calories_burned | REAL | | 消耗热量(kcal) |
| distance | REAL | | 运动距离(km) |
| heart_rate | INTEGER | | 平均心率 |
| notes | TEXT | | 备注 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

#### 3.2.4 睡眠记录表 (sleep_records)

记录用户的睡眠情况，包括睡眠时间、质量等信息。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| record_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 记录唯一标识 |
| user_id | INTEGER | NOT NULL, FOREIGN KEY | 关联用户ID |
| date | DATE | NOT NULL | 记录日期 |
| sleep_time | DATETIME | NOT NULL | 入睡时间 |
| wake_time | DATETIME | NOT NULL | 醒来时间 |
| duration | INTEGER | NOT NULL | 睡眠时长(分钟) |
| quality | INTEGER | | 睡眠质量(1-5) |
| interruptions | INTEGER | | 中断次数 |
| dream | TEXT | | 梦境记录 |
| factors | TEXT | | 影响因素 |
| notes | TEXT | | 备注 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

#### 3.2.5 食物信息表 (foods)

存储食物的基本信息和营养成分。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| food_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 食物唯一标识 |
| name | TEXT | NOT NULL | 食物名称 |
| category | TEXT | | 食物类别 |
| calories_per_unit | REAL | NOT NULL | 单位热量(kcal) |
| protein_per_unit | REAL | | 单位蛋白质含量(g) |
| fat_per_unit | REAL | | 单位脂肪含量(g) |
| carbs_per_unit | REAL | | 单位碳水化合物含量(g) |
| fiber_per_unit | REAL | | 单位纤维含量(g) |
| default_unit | TEXT | NOT NULL | 默认计量单位 |
| description | TEXT | | 食物描述 |
| image_path | TEXT | | 食物图片路径 |
| is_custom | BOOLEAN | NOT NULL DEFAULT 0 | 是否用户自定义 |
| user_id | INTEGER | FOREIGN KEY | 创建该食物的用户ID |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

#### 3.2.6 运动信息表 (exercises)

存储运动类型和相关信息。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| exercise_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 运动唯一标识 |
| name | TEXT | NOT NULL | 运动名称 |
| category | TEXT | | 运动类别 |
| calories_per_minute | REAL | | 每分钟消耗热量(kcal) |
| description | TEXT | | 运动描述 |
| image_path | TEXT | | 运动图片路径 |
| is_custom | BOOLEAN | NOT NULL DEFAULT 0 | 是否用户自定义 |
| user_id | INTEGER | FOREIGN KEY | 创建该运动的用户ID |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

#### 3.2.7 提醒事项表 (reminders)

存储用户设置的提醒，例如饮水、服药、运动提醒等。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| reminder_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 提醒唯一标识 |
| user_id | INTEGER | NOT NULL, FOREIGN KEY | 关联用户ID |
| title | TEXT | NOT NULL | 提醒标题 |
| description | TEXT | | 提醒描述 |
| type | TEXT | NOT NULL | 提醒类型(饮食/运动/睡眠/其他) |
| time | TIME | NOT NULL | 提醒时间 |
| days_of_week | TEXT | | 每周重复日(1-7) |
| is_active | BOOLEAN | NOT NULL DEFAULT 1 | 是否激活 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| last_triggered | DATETIME | | 最后触发时间 |

### 3.3 数据访问层设计

数据访问层提供统一的接口，用于业务逻辑层与数据库之间的交互。主要设计如下：

#### 数据库连接管理

通过 `db_manager.py` 实现数据库连接池和会话管理，确保高效、安全的数据库访问：

```python
class DatabaseManager:
    def __init__(self, db_path):
        """初始化数据库管理器"""
        self.db_path = db_path
        self.connection = None
        
    def connect(self):
        """建立数据库连接"""
        # 创建数据库连接并配置
        
    def execute_query(self, query, params=()):
        """执行查询操作"""
        # 执行SQL查询并返回结果
        
    def execute_update(self, query, params=()):
        """执行更新操作"""
        # 执行SQL更新并返回影响行数
        
    def initialize(self):
        """初始化数据库结构"""
        # 创建所需的表和索引
```

#### 数据访问模式

采用 Data Access Object (DAO) 模式，为每个主要实体创建专门的访问类：

```python
class UserDAO:
    def __init__(self, db_manager):
        self.db_manager = db_manager
        
    def get_user_by_id(self, user_id):
        """根据ID获取用户"""
        
    def get_user_by_username(self, username):
        """根据用户名获取用户"""
        
    def create_user(self, user_data):
        """创建新用户"""
        
    def update_user(self, user_id, user_data):
        """更新用户信息"""
        
    def delete_user(self, user_id):
        """删除用户"""
```

类似的DAO实现也用于其他实体（饮食记录、运动记录、睡眠记录等）。

#### 数据验证与安全

数据访问层还负责：
- 输入验证：确保数据符合格式和业务规则
- 参数化查询：防止SQL注入攻击
- 数据完整性：通过事务确保原子操作
- 错误处理：提供统一的错误报告机制

通过这种设计，数据访问层为上层提供了安全、一致的数据操作接口，同时隐藏了数据库实现的细节，提高了代码的可维护性和可测试性。 